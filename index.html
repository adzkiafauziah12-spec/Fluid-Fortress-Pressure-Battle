<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fluid Fortress - Tactical Command</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- KaTeX untuk Rumus Fisika yang Jelas -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; font-family: 'Plus Jakarta Sans', sans-serif;
            background: #001e3c;
        }

        #canvas-container { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 1;
        }

        .ui-root { position: relative; z-index: 10; height: 100vh; pointer-events: none; }
        .pointer-auto { pointer-events: auto; }

        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .glass-dark {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .hp-bar-fill { transition: width 0.8s cubic-bezier(0.22, 1, 0.36, 1); }
        
        .math-display {
            font-size: 1.2rem;
            line-height: 1.6;
            color: #1e293b;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .ship-float { animation: float 4s ease-in-out infinite; }

        .btn-primary {
            background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
            box-shadow: 0 4px 14px 0 rgba(2, 132, 199, 0.39);
        }

        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body>

    <div id="canvas-container"></div>
    <div id="root" class="ui-root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const MAX_HP = 300;
        const SHIP_COLORS = [
            { id: 'blue', hex: 0x0ea5e9, tailwind: 'bg-sky-500' },
            { id: 'red', hex: 0xef4444, tailwind: 'bg-red-500' },
            { id: 'emerald', hex: 0x10b981, tailwind: 'bg-emerald-500' },
            { id: 'amber', hex: 0xf59e0b, tailwind: 'bg-amber-500' }
        ];

        const SOAL_POOL = {
            "Sangat Mudah": [
                { q: "Satuan SI untuk tekanan adalah...", a: ["Pascal ($Pa$)", "Newton ($N$)", "Joule ($J$)", "Watt ($W$)"], c: 0 },
                { q: "Tekanan ($P$) didefinisikan sebagai gaya per satuan...", a: ["Luas ($A$)", "Volume ($V$)", "Massa ($m$)", "Waktu ($t$)"], c: 0 },
                { q: "Alat pengukur tekanan atmosfer adalah...", a: ["Barometer", "Termometer", "Higrometer", "Speedometer"], c: 0 },
                { q: "Zat yang mengalir disebut...", a: ["Fluida", "Solid", "Kristal", "Rigid"], c: 0 },
                { q: "Hukum yang menyatakan tekanan diteruskan ke segala arah adalah...", a: ["Hukum Pascal", "Hukum Ohm", "Hukum Hooke", "Hukum Gay-Lussac"], c: 0 },
                { q: "Benda terapung jika massa jenisnya...", a: ["Lebih kecil dari air", "Lebih besar dari air", "Sama dengan air", "Dua kali air"], c: 0 },
                { q: "Simbol massa jenis adalah...", a: ["$\\rho$", "$\\alpha$", "$\\beta$", "$\\gamma$"], c: 0 },
                { q: "Gaya angkat ke atas disebut gaya...", a: ["Archimedes", "Gravitasi", "Sentrifugal", "Gesek"], c: 0 },
                { q: "Tekanan hidrostatis bergantung pada...", a: ["Kedalaman", "Warna wadah", "Bentuk wadah", "Luas permukaan"], c: 0 },
                { q: "Serangga bisa berjalan di air karena...", a: ["Tegangan permukaan", "Viskositas", "Kapilaritas", "Adhesi"], c: 0 },
                { q: "Manometer digunakan untuk mengukur tekanan...", a: ["Gas ruang tertutup", "Udara luar", "Darah", "Ban"], c: 0 },
                { q: "Satuan massa jenis dalam SI adalah...", a: ["$kg/m^3$", "$g/cm^3$", "$kg/cm^2$", "$N/m^3$"], c: 0 },
                { q: "Fluida statis berarti fluida dalam kondisi...", a: ["Diam", "Bergerak cepat", "Membeku", "Menguap"], c: 0 },
                { q: "Dongkrak hidrolik menggunakan prinsip...", a: ["Pascal", "Bernoulli", "Newton", "Stoke"], c: 0 },
                { q: "Kapal selam menyelam dengan cara...", a: ["Mengisi tangki ballast", "Mempercepat mesin", "Mengecilkan badan", "Membuang jangkar"], c: 0 },
                { q: "Massa jenis air adalah...", a: ["$1000\\ kg/m^3$", "$100\\ kg/m^3$", "$10\\ kg/m^3$", "$1\\ kg/m^3$"], c: 0 },
                { q: "Fenomena naiknya air pada pipa sempit disebut...", a: ["Kapilaritas", "Viskositas", "Difusi", "Osmosis"], c: 0 },
                { q: "Zat cair yang sukar mengalir memiliki...", a: ["Viskositas tinggi", "Viskositas rendah", "Massa jenis kecil", "Tekanan tinggi"], c: 0 },
                { q: "Hukum Archimedes berlaku pada...", a: ["Zat cair dan gas", "Hanya padat", "Hanya logam", "Hanya minyak"], c: 0 },
                { q: "Jika luas penampang diperkecil, tekanan akan...", a: ["Meningkat", "Menurun", "Tetap", "Nol"], c: 0 }
            ],
            "Mudah": [
                { q: "Rumus tekanan hidrostatis adalah...", a: ["$P_h = \\rho \\cdot g \\cdot h$", "$P = F/A$", "$P = m \\cdot g$", "$P = V \\cdot h$"], c: 0 },
                { q: "Benda melayang terjadi saat...", a: ["$\\rho_{benda} = \\rho_{cair}$", "$\\rho_{benda} < \\rho_{cair}$", "$\\rho_{benda} > \\rho_{cair}$", "$F_a < W$"], c: 0 },
                { q: "Gaya ke atas ($F_a$) dirumuskan sebagai...", a: ["$\\rho_{f} \\cdot V_{bf} \\cdot g$", "$m \\cdot g$", "$P \\cdot A$", "$\\rho \\cdot V$"], c: 0 },
                { q: "Tekanan udara di permukaan laut adalah...", a: ["$1\\ atm$", "$10\\ atm$", "$0,5\\ atm$", "$76\\ atm$"], c: 0 },
                { q: "Meniskus cekung terjadi jika...", a: ["Adhesi > Kohesi", "Kohesi > Adhesi", "Adhesi = Kohesi", "Gravitasi kuat"], c: 0 },
                { q: "Rem hidrolik adalah aplikasi dari...", a: ["Hukum Pascal", "Hukum Archimedes", "Hukum Boyle", "Hukum Newton"], c: 0 },
                { q: "Satuan viskositas adalah...", a: ["$Pa \\cdot s$", "$N/m$", "$kg/m^2$", "$J$"], c: 0 },
                { q: "Gaya hambat pada bola yang jatuh di fluida disebut gaya...", a: ["Stokes", "Lorentz", "Coulomb", "Normal"], c: 0 },
                { q: "Silet bisa terapung karena...", a: ["Tegangan permukaan", "Massa silet nol", "Silet berongga", "Gaya magnet"], c: 0 },
                { q: "Besar gaya Archimedes sama dengan...", a: ["Berat zat cair yang dipindahkan", "Berat benda", "Volume benda", "Massa benda"], c: 0 },
                { q: "Sudut kontak air pada kaca adalah...", a: ["Lancip (< 90Â°)", "Tumpul (> 90Â°)", "Siku-siku", "Lurus"], c: 0 },
                { q: "Alat pengangkat mobil memiliki piston. Rasio gaya sebanding dengan rasio...", a: ["Luas penampang", "Massa piston", "Panjang piston", "Waktu tekan"], c: 0 },
                { q: "Tegangan permukaan ($\gamma$) dirumuskan...", a: ["$F/d$", "$F \\cdot d$", "$m/V$", "$P \\cdot h$"], c: 0 },
                { q: "Barometer raksa pertama kali dibuat oleh...", a: ["Torricelli", "Pascal", "Archimedes", "Newton"], c: 0 },
                { q: "Massa jenis es lebih kecil dari air, maka es...", a: ["Terapung", "Tenggelam", "Melayang", "Menyublim"], c: 0 },
                { q: "Pipa U digunakan untuk menentukan...", a: ["Massa jenis zat cair", "Kecepatan aliran", "Suhu fluida", "Volume benda"], c: 0 },
                { q: "Hukum Archimedes ditemukan saat ilmuwan tersebut sedang...", a: ["Mandi", "Makan", "Tidur", "Lari"], c: 0 },
                { q: "Tekanan 1 atm setara dengan...", a: ["$760\\ mmHg$", "$76\\ mmHg$", "$7,6\\ mmHg$", "$100\\ mmHg$"], c: 0 },
                { q: "Raksa pada kaca membentuk meniskus...", a: ["Cembung", "Cekung", "Datar", "Spiral"], c: 1 },
                { q: "Balon udara bisa terbang karena berisi gas yang...", a: ["Lebih ringan dari udara", "Lebih berat dari udara", "Sangat panas", "Berwarna"], c: 0 }
            ],
            "Sedang": [
                { q: "Berapa tekanan jika gaya $200\\ N$ bekerja pada luas $0,5\\ m^2$?", a: ["$400\\ Pa$", "$100\\ Pa$", "$1000\\ Pa$", "$250\\ Pa$"], c: 0 },
                { q: "Hitung $P_h$ pada kedalaman $2\\ m$ ($\rho=1000, g=10$)?", a: ["$20.000\\ Pa$", "$2.000\\ Pa$", "$200\\ Pa$", "$500\\ Pa$"], c: 0 },
                { q: "Piston kecil $2\\ cm^2$, besar $20\\ cm^2$. Jika input $50\\ N$, outputnya?", a: ["$500\\ N$", "$100\\ N$", "$250\\ N$", "$50\\ N$"], c: 0 },
                { q: "Benda volume $0,002\\ m^3$ tercelup di air. Gaya apungnya?", a: ["$20\\ N$", "$2\\ N$", "$200\\ N$", "$0,2\\ N$"], c: 0 },
                { q: "Pipa U berisi air. Sisi lain diisi minyak ($\rho=0,8$) tinggi $10\\ cm$. Tinggi air?", a: ["$8\\ cm$", "$10\\ cm$", "$12,5\\ cm$", "$2\\ cm$"], c: 0 },
                { q: "Balok kayu terapung, 20% volumenya muncul. Berapa $\rho_{kayu}$?", a: ["$800\\ kg/m^3$", "$200\\ kg/m^3$", "$1000\\ kg/m^3$", "$500\\ kg/m^3$"], c: 0 },
                { q: "Kenaikan air di pipa $r=1\\ mm$ ($\gamma=0,07, \theta=0$)?", a: ["$1,4\\ cm$", "$2,8\\ cm$", "$0,7\\ cm$", "$5,6\\ cm$"], c: 0 },
                { q: "Bola $r=0,01\\ m$ jatuh di oli ($\eta=0,1$) dengan $v=5\\ m/s$. Gaya Stokes?", a: ["$0,018\\pi\\ N$", "$0,06\\pi\\ N$", "$0,1\\pi\\ N$", "$0,5\\pi\\ N$"], c: 0 },
                { q: "Benda di udara $50\\ N$, di air $40\\ N$. Volume benda?", a: ["$10^{-3}\\ m^3$", "$10^{-2}\\ m^3$", "$10^{-1}\\ m^3$", "$1\\ m^3$"], c: 0 },
                { q: "Tekanan mutlak di kedalaman $10\\ m$ ($P_{atm}=10^5$)?", a: ["$2 \\cdot 10^5\\ Pa$", "$1 \\cdot 10^5\\ Pa$", "$1,1 \\cdot 10^5\\ Pa$", "$3 \\cdot 10^5\\ Pa$"], c: 0 },
                { q: "Berat semu benda $2\\ kg$ di air jika berat aslinya $30\\ N$?", a: ["$10\\ N$", "$20\\ N$", "$15\\ N$", "$5\\ N$"], c: 0 },
                { q: "Massa jenis benda yang 3/4 bagiannya tercelup di air?", a: ["$750\\ kg/m^3$", "$250\\ kg/m^3$", "$500\\ kg/m^3$", "$1000\\ kg/m^3$"], c: 0 },
                { q: "Jika tekanan naik $1\\ atm$ setiap $10\\ m$, tekanan di kedalaman $50\\ m$ adalah...", a: ["$6\\ atm$", "$5\\ atm$", "$4\\ atm$", "$10\\ atm$"], c: 0 },
                { q: "Gaya tegangan permukaan pada kawat $5\\ cm$ ($\gamma=0,02$)?", a: ["$0,002\\ N$", "$0,001\\ N$", "$0,01\\ N$", "$0,1\\ N$"], c: 0 },
                { q: "Debit air pipa penampang $0,01\\ m^2$ dengan $v=2\\ m/s$?", a: ["$0,02\\ m^3/s$", "$200\\ m^3/s$", "$2\\ m^3/s$", "$0,1\\ m^3/s$"], c: 0 },
                { q: "Berapa massa jenis raksa dalam $g/cm^3$?", a: ["$13,6$", "$1$", "$0,8$", "$10$"], c: 0 },
                { q: "Kecepatan terminal bola berbanding lurus dengan...", a: ["Kuadrat jari-jari", "Jari-jari", "Massa", "Waktu"], c: 0 },
                { q: "Tekanan hidrostatis di dasar tangki setinggi $5\\ m$ berisi minyak ($\rho=0,8$)?", a: ["$40.000\\ Pa$", "$50.000\\ Pa$", "$8.000\\ Pa$", "$400\\ Pa$"], c: 0 },
                { q: "Pipa kapiler $r_1$ naik $h$. Jika pipa $r_2=2r_1$, naiknya?", a: ["$0,5h$", "$2h$", "$h$", "$4h$"], c: 0 },
                { q: "Alat untuk mengukur massa jenis zat cair secara langsung adalah...", a: ["Hidrometer", "Hygrometer", "Manometer", "Venturimeter"], c: 0 }
            ],
            "Sulit": [
                { q: "Balok $\\rho=600\\ kg/m^3$ terapung di air. Beban $m$ agar tepat tenggelam seluruhnya jika $V_{balok}=0,1\\ m^3$?", a: ["$40\\ kg$", "$60\\ kg$", "$100\\ kg$", "$20\\ kg$"], c: 0 },
                { q: "Bola besi $r=1\\ cm$ jatuh dalam gliserin ($\\eta=1,5, \\rho=1200$). $v_{terminal}$ bola ($\\rho_{besi}=7800$)?", a: ["$0,98\\ m/s$", "$1,96\\ m/s$", "$0,49\\ m/s$", "$3,12\\ m/s$"], c: 0 },
                { q: "Benda di udara $100\\ N$, di air $80\\ N$, di zat X $75\\ N$. $\\rho_X$?", a: ["$1250\\ kg/m^3$", "$1200\\ kg/m^3$", "$1500\\ kg/m^3$", "$800\\ kg/m^3$"], c: 0 },
                { q: "Pipa U luas $2\\ cm^2$ berisi raksa. Dimasukkan $100\\ g$ air. Selisih tinggi raksa?", a: ["$3,67\\ cm$", "$7,35\\ cm$", "$1,84\\ cm$", "$10\\ cm$"], c: 0 },
                { q: "Kerja untuk meniup gelembung sabun ($\gamma=0,03$) dari $r=2\\ cm$ ke $r=5\\ cm$?", a: ["$1,58 \\cdot 10^{-3}\\ J$", "$3,16 \\cdot 10^{-3}\\ J$", "$0,79 \\cdot 10^{-3}\\ J$", "$5,2 \\cdot 10^{-3}\\ J$"], c: 0 },
                { q: "Kubus sisi $10\\ cm$ melayang di antara air dan minyak ($\rho=0,8$). $4\\ cm$ di minyak, sisanya di air. $\rho_{kubus}$?", a: ["$920\\ kg/m^3$", "$880\\ kg/m^3$", "$900\\ kg/m^3$", "$840\\ kg/m^3$"], c: 0 },
                { q: "Kawat luncur $10\\ cm$ membawa sabun. Massa kawat $0,5\\ g$. $\gamma$ sabun?", a: ["$0,0245\\ N/m$", "$0,049\\ N/m$", "$0,01\\ N/m$", "$0,1\\ N/m$"], c: 0 },
                { q: "Tekanan pada kedalaman $100\\ m$ laut ($\rho=1025, P_{atm}=10^5$)?", a: ["$1,125 \\cdot 10^6\\ Pa$", "$1,025 \\cdot 10^6\\ Pa$", "$2 \\cdot 10^6\\ Pa$", "$10^6\\ Pa$"], c: 0 },
                { q: "Sebuah bola berongga melayang di air. $r_{luar}=10\\ cm, r_{dalam}=9\\ cm$. $\rho_{bahan}$?", a: ["$3,69\\ g/cm^3$", "$2,50\\ g/cm^3$", "$1,85\\ g/cm^3$", "$4,2\\ g/cm^3$"], c: 0 },
                { q: "Balok terapung di air 2/3 bagian tercelup. Di minyak $\rho=0,8$, bagian yang tercelup?", a: ["5/6 bagian", "1/2 bagian", "3/4 bagian", "Seluruhnya"], c: 0 },
                { q: "Dua tetes raksa $r=1\\ mm$ bergabung. Energi yang dilepaskan ($\gamma=0,48$)?", a: ["$1,2 \\cdot 10^{-6}\\ J$", "$2,4 \\cdot 10^{-6}\\ J$", "$0,6 \\cdot 10^{-6}\\ J$", "$4,8 \\cdot 10^{-6}\\ J$"], c: 0 },
                { q: "Kecepatan air keluar dari lubang tangki pada kedalaman $5\\ m$?", a: ["$10\\ m/s$", "$20\\ m/s$", "$5\\ m/s$", "$15\\ m/s$"], c: 0 },
                { q: "Gaya Archimedes balon udara $500\\ m^3$ ($\rho_{udara}=1,2$)?", a: ["$6000\\ N$", "$5000\\ N$", "$1200\\ N$", "$600\\ N$"], c: 0 },
                { q: "Massa jenis es $0,9$ dan air laut $1,03$. Persen es di atas permukaan?", a: ["12,6%", "10%", "15%", "90%"], c: 0 },
                { q: "Pipa kapiler $r=0,2\\ mm$ di raksa ($\gamma=0,48, \\theta=140^\circ, \\rho=13600$). Penurunan raksa?", a: ["$2,7\\ cm$", "$5,4\\ cm$", "$1,3\\ cm$", "$0,5\\ cm$"], c: 0 },
                { q: "Sebuah kapal $m=10.000\\ ton$ terapung. Volume air laut ($\rho=1025$) yang dipindahkan?", a: ["$9756\\ m^3$", "$10000\\ m^3$", "$10250\\ m^3$", "$8500\\ m^3$"], c: 0 },
                { q: "Viskositas fluida diukur dengan bola jatuh. Jika $r$ jadi $2r$, waktu jatuh menjadi...", a: ["$1/4$ kali", "$1/2$ kali", "$2$ kali", "$4$ kali"], c: 0 },
                { q: "Tekanan di dalam gelembung sabun $r=1\\ cm, \\gamma=0,025$ dibanding udara luar?", a: ["$+10\\ Pa$", "$+5\\ Pa$", "$+2,5\\ Pa$", "$+20\\ Pa$"], c: 0 },
                { q: "Berat batu $100\\ N$ di udara, $60\\ N$ di air. $\rho_{batu}$?", a: ["$2500\\ kg/m^3$", "$1500\\ kg/m^3$", "$4000\\ kg/m^3$", "$1000\\ kg/m^3$"], c: 0 },
                { q: "Sebuah hidrometer massa $50\\ g$ luas batang $0,5\\ cm^2$ melayang di air. Panjang batang yang muncul jika dicelup ke $\rho=1,1$?", a: ["$9,1\\ cm$", "$4,5\\ cm$", "$18,2\\ cm$", "$2\\ cm$"], c: 0 }
            ]
        };

        const CATEGORIES = [
            { id: "Sangat Mudah", icon: "anchor", color: "text-emerald-500", t: 90, dmg: 40, pool: SOAL_POOL["Sangat Mudah"] },
            { id: "Mudah", icon: "navigation", color: "text-sky-500", t: 90, dmg: 60, pool: SOAL_POOL["Mudah"] },
            { id: "Sedang", icon: "target", color: "text-amber-500", t: 90, dmg: 100, pool: SOAL_POOL["Sedang"] },
            { id: "Sulit", icon: "zap", color: "text-rose-500", t: 120, dmg: 160, pool: SOAL_POOL["Sulit"] }
        ];

        function App() {
            const [gameState, setGameState] = useState('HOME'); // HOME, SETUP, TURN_SELECT, PLAY, END
            const [p1, setP1] = useState({ name: 'Admiral Alpha', hp: MAX_HP, color: SHIP_COLORS[0], score: 0 });
            const [p2, setP2] = useState({ name: 'Admiral Bravo', hp: MAX_HP, color: SHIP_COLORS[1], score: 0 });
            const [activePlayer, setActivePlayer] = useState(1);
            const [gameTime, setGameTime] = useState(300);
            const [timeLeft, setTimeLeft] = useState(300);
            const [turnTimer, setTurnTimer] = useState(90);
            const [currentQ, setCurrentQ] = useState(null);
            const [log, setLog] = useState("Menunggu koordinat...");
            const [showInfo, setShowInfo] = useState(false);
            
            const shipsRef = useRef([]);
            const sceneRef = useRef(null);

            // Three.js Scene Setup
            useEffect(() => {
                const scene = new THREE.Scene();
                sceneRef.current = scene;
                const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 2000);
                const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(window.devicePixelRatio);
                document.getElementById('canvas-container').appendChild(renderer.domElement);

                // Lighting
                const ambient = new THREE.AmbientLight(0xffffff, 0.7);
                scene.add(ambient);
                const sun = new THREE.DirectionalLight(0xffffff, 1.2);
                sun.position.set(100, 200, 100);
                scene.add(sun);

                // Water
                const waterGeo = new THREE.PlaneGeometry(2000, 2000, 128, 128);
                const waterMat = new THREE.MeshPhongMaterial({
                    color: 0x075985,
                    shininess: 150,
                    specular: 0x22d3ee,
                    transparent: true,
                    opacity: 0.9,
                    flatShading: false
                });
                const water = new THREE.Mesh(waterGeo, waterMat);
                water.rotation.x = -Math.PI / 2;
                water.position.y = -5;
                scene.add(water);

                // Ships
                const createShip = (x, colorHex) => {
                    const group = new THREE.Group();
                    const hullGeo = new THREE.BoxGeometry(10, 2.5, 4);
                    const hullMat = new THREE.MeshPhongMaterial({ color: colorHex });
                    const hull = new THREE.Mesh(hullGeo, hullMat);
                    
                    const deckGeo = new THREE.BoxGeometry(6, 1.5, 3);
                    const deckMat = new THREE.MeshPhongMaterial({ color: 0x334155 });
                    const deck = new THREE.Mesh(deckGeo, deckMat);
                    deck.position.set(-1, 2, 0);

                    const towerGeo = new THREE.BoxGeometry(2, 2.5, 1.5);
                    const tower = new THREE.Mesh(towerGeo, deckMat);
                    tower.position.set(-1, 3.5, 0);

                    group.add(hull, deck, tower);
                    group.position.set(x, -4.5, 0);
                    if (x > 0) group.rotation.y = Math.PI;
                    scene.add(group);
                    return group;
                };

                const ship1 = createShip(-25, p1.color.hex);
                const ship2 = createShip(25, p2.color.hex);
                shipsRef.current = [ship1, ship2];

                camera.position.set(0, 15, 60);
                camera.lookAt(0, 0, 0);

                const animate = () => {
                    requestAnimationFrame(animate);
                    const t = performance.now() * 0.001;
                    
                    // Wave simulation
                    const pos = water.geometry.attributes.position.array;
                    for (let i = 0; i < pos.length; i += 3) {
                        const px = pos[i];
                        const py = pos[i+1];
                        pos[i+2] = Math.sin(px * 0.05 + t) * 0.8 + Math.cos(py * 0.05 + t) * 0.5;
                    }
                    water.geometry.attributes.position.needsUpdate = true;

                    // Ship bobbing
                    shipsRef.current.forEach((s, i) => {
                        s.position.y = -4.5 + Math.sin(t + i) * 0.4;
                        s.rotation.z = Math.sin(t * 0.5 + i) * 0.05;
                    });

                    renderer.render(scene, camera);
                };
                animate();

                const handleResize = () => {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                };
                window.addEventListener('resize', handleResize);

                return () => {
                    window.removeEventListener('resize', handleResize);
                    renderer.dispose();
                };
            }, []);

            // Update Ship Colors
            useEffect(() => {
                if (shipsRef.current[0]) {
                    shipsRef.current[0].children[0].material.color.setHex(p1.color.hex);
                }
                if (shipsRef.current[1]) {
                    shipsRef.current[1].children[0].material.color.setHex(p2.color.hex);
                }
            }, [p1.color, p2.color]);

            // Game Logic Timers
            useEffect(() => {
                let timer;
                if (gameState === 'PLAY') {
                    timer = setInterval(() => {
                        setTimeLeft(prev => {
                            if (prev <= 1) { endGame(); return 0; }
                            return prev - 1;
                        });
                        setTurnTimer(prev => {
                            if (prev <= 1) { handleMiss(); return 0; }
                            return prev - 1;
                        });
                    }, 1000);
                }
                return () => clearInterval(timer);
            }, [gameState]);

            const handleMiss = () => {
                setLog("âš ï¸ Waktu habis! Kerusakan pada sistem sendiri!");
                const active = activePlayer === 1 ? setP1 : setP2;
                active(p => ({ ...p, hp: Math.max(0, p.hp - 30) }));
                setTimeout(() => nextTurn(), 1500);
            };

            const nextTurn = () => {
                if (p1.hp <= 0 || p2.hp <= 0) {
                    endGame();
                } else {
                    setActivePlayer(activePlayer === 1 ? 2 : 1);
                    setCurrentQ(null);
                    setTurnTimer(90);
                }
            };

            const endGame = () => {
                setGameState('END');
            };

            const selectCategory = (cat) => {
                const shuffled = [...cat.pool].sort(() => Math.random() - 0.5);
                setCurrentQ({ ...shuffled[0], category: cat.id, timer: cat.t, dmg: cat.dmg });
                setTurnTimer(cat.t);
            };

            const submitAnswer = (idx) => {
                const isCorrect = idx === currentQ.c;
                if (isCorrect) {
                    setLog("ðŸ”¥ Tembakan Telak! Musuh mengalami kerusakan besar!");
                    const enemy = activePlayer === 1 ? setP2 : setP1;
                    const self = activePlayer === 1 ? setP1 : setP2;
                    enemy(e => ({ ...e, hp: Math.max(0, e.hp - currentQ.dmg) }));
                    self(s => ({ ...s, score: s.score + 1 }));
                } else {
                    setLog("âŒ Meleset! Ledakan balik merusak dek kapal!");
                    const self = activePlayer === 1 ? setP1 : setP2;
                    self(s => ({ ...s, hp: Math.max(0, s.hp - 20) }));
                }
                setTimeout(() => nextTurn(), 1500);
            };

            // KaTeX Rendering
            useEffect(() => {
                document.querySelectorAll('.math-box').forEach(el => {
                    const math = el.getAttribute('data-math');
                    if (math) {
                        try {
                            katex.render(math.replace(/\$/g, ''), el, { throwOnError: false, displayMode: false });
                        } catch(e) {}
                    }
                });
            }, [currentQ]);

            return (
                <div className="h-full w-full flex flex-col relative">
                    
                    {/* Home Screen */}
                    {gameState === 'HOME' && (
                        <div className="flex-1 flex flex-col items-center justify-center p-6 pointer-auto">
                            <div className="text-center space-y-8 max-w-2xl">
                                <h1 className="text-6xl font-black text-white italic tracking-tighter uppercase drop-shadow-2xl">Fluid Fortress</h1>
                                <p className="text-sky-200 font-bold tracking-widest uppercase text-sm">Tactical Physics Naval Warfare</p>
                                
                                <div className="flex flex-col gap-4 mt-12">
                                    <button onClick={() => setGameState('SETUP')} className="btn-primary text-white px-12 py-5 rounded-2xl font-black text-xl uppercase tracking-widest hover:scale-105 transition-all shadow-xl">Start Mission</button>
                                    <button onClick={() => setShowInfo(true)} className="glass text-slate-800 px-12 py-4 rounded-2xl font-bold uppercase tracking-widest hover:bg-white transition-all flex items-center justify-center gap-2">
                                        <i data-lucide="info" className="w-5 h-5"></i> Developer Info
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Developer Info Pop-up */}
                    {showInfo && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-slate-900/60 backdrop-blur-md pointer-auto">
                            <div className="glass-dark p-10 rounded-[3rem] w-full max-w-md text-white border-white/20 shadow-2xl animate-in zoom-in-95 duration-300">
                                <div className="flex justify-between items-start mb-8">
                                    <h2 className="text-2xl font-black uppercase italic">Developer Intel</h2>
                                    <button onClick={() => setShowInfo(false)} className="p-2 hover:bg-white/10 rounded-full transition-all">
                                        <i data-lucide="x" className="w-6 h-6"></i>
                                    </button>
                                </div>
                                <div className="space-y-6">
                                    <div className="flex flex-col gap-1">
                                        <span className="text-[10px] uppercase font-bold text-sky-400 tracking-widest">Nama Lengkap</span>
                                        <p className="text-xl font-bold">Adzkia Sufi Fauziah</p>
                                    </div>
                                    <div className="flex flex-col gap-1">
                                        <span className="text-[10px] uppercase font-bold text-sky-400 tracking-widest">Instansi</span>
                                        <p className="text-xl font-bold">SMAN 1 Sleman</p>
                                    </div>
                                    <div className="flex flex-col gap-1">
                                        <span className="text-[10px] uppercase font-bold text-sky-400 tracking-widest">Instagram</span>
                                        <p className="text-xl font-bold text-sky-300 underline">@adzkiasf</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Setup Screen */}
                    {gameState === 'SETUP' && (
                        <div className="flex-1 flex items-center justify-center p-6 pointer-auto">
                            <div className="glass p-12 rounded-[3.5rem] w-full max-w-4xl shadow-2xl border-white/50">
                                <h2 className="text-3xl font-black text-center mb-12 uppercase italic text-sky-900">Battle Readiness</h2>
                                
                                <div className="grid grid-cols-2 gap-12 mb-12">
                                    <div className="space-y-6">
                                        <label className="text-[10px] font-black uppercase text-sky-600 tracking-widest">Armada Alpha</label>
                                        <input className="w-full bg-white/60 border-b-2 border-sky-300 p-4 font-bold text-xl outline-none focus:border-sky-600 rounded-xl" value={p1.name} onChange={e=>setP1({...p1, name: e.target.value})} />
                                        <div className="flex gap-3">
                                            {SHIP_COLORS.map((c, i) => (
                                                <button key={i} onClick={()=>setP1({...p1, color: c})} className={`w-10 h-10 rounded-xl ${c.tailwind} ${p1.color.id === c.id ? 'ring-4 ring-white shadow-lg scale-110' : 'opacity-40'}`}></button>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="space-y-6 text-right">
                                        <label className="text-[10px] font-black uppercase text-red-600 tracking-widest">Armada Bravo</label>
                                        <input className="w-full bg-white/60 border-b-2 border-red-300 p-4 font-bold text-xl outline-none focus:border-red-600 text-right rounded-xl" value={p2.name} onChange={e=>setP2({...p2, name: e.target.value})} />
                                        <div className="flex gap-3 justify-end">
                                            {SHIP_COLORS.map((c, i) => (
                                                <button key={i} onClick={()=>setP2({...p2, color: c})} className={`w-10 h-10 rounded-xl ${c.tailwind} ${p2.color.id === c.id ? 'ring-4 ring-white shadow-lg scale-110' : 'opacity-40'}`}></button>
                                            ))}
                                        </div>
                                    </div>
                                </div>

                                <div className="mb-12 text-center">
                                    <p className="text-[10px] font-black uppercase text-slate-500 mb-6 tracking-widest">Durasi Operasi</p>
                                    <div className="flex gap-4 justify-center">
                                        {[300, 600, 900].map(sec => (
                                            <button key={sec} onClick={()=>setGameTime(sec)} className={`px-8 py-3 rounded-2xl font-black transition-all ${gameTime === sec ? 'bg-sky-700 text-white shadow-lg scale-110' : 'bg-slate-200 text-slate-500'}`}>
                                                {sec/60} Menit
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <button onClick={() => setGameState('TURN_SELECT')} className="w-full btn-primary text-white py-6 rounded-[2rem] font-black text-xl uppercase tracking-widest shadow-xl">Lanjutkan</button>
                            </div>
                        </div>
                    )}

                    {/* First Strike Selection */}
                    {gameState === 'TURN_SELECT' && (
                        <div className="flex-1 flex items-center justify-center p-6 pointer-auto">
                            <div className="glass p-12 rounded-[3.5rem] w-full max-w-2xl text-center">
                                <h2 className="text-3xl font-black mb-8 uppercase italic text-sky-900">Inisiatif Serangan</h2>
                                <p className="text-slate-500 font-bold mb-10">Siapa yang akan meluncurkan serangan pertama?</p>
                                <div className="grid grid-cols-2 gap-6">
                                    <button onClick={() => {setActivePlayer(1); setTimeLeft(gameTime); setGameState('PLAY');}} className="p-8 rounded-3xl bg-sky-50 border-2 border-sky-200 hover:bg-sky-100 transition-all group">
                                        <i data-lucide="ship" className="w-12 h-12 text-sky-600 mb-4 mx-auto group-hover:rotate-12 transition-transform"></i>
                                        <p className="font-black text-sky-800 uppercase">{p1.name}</p>
                                    </button>
                                    <button onClick={() => {setActivePlayer(2); setTimeLeft(gameTime); setGameState('PLAY');}} className="p-8 rounded-3xl bg-red-50 border-2 border-red-200 hover:bg-red-100 transition-all group">
                                        <i data-lucide="ship" className="w-12 h-12 text-red-600 mb-4 mx-auto group-hover:-rotate-12 transition-transform"></i>
                                        <p className="font-black text-red-800 uppercase">{p2.name}</p>
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Battle Arena */}
                    {gameState === 'PLAY' && (
                        <div className="flex-1 flex flex-col justify-between p-8">
                            <div className="flex justify-between items-start">
                                <div className={`w-80 p-6 glass rounded-[2.5rem] transition-all duration-500 ${activePlayer === 1 ? 'ring-4 ring-sky-500 scale-105 shadow-2xl' : 'opacity-50'}`}>
                                    <div className="flex justify-between items-end mb-3">
                                        <span className="text-[10px] font-black uppercase text-sky-700">{p1.name}</span>
                                        <span className="font-mono text-sm font-bold">{Math.round(p1.hp)} HP</span>
                                    </div>
                                    <div className="h-3 bg-slate-200 rounded-full overflow-hidden">
                                        <div className={`hp-bar-fill h-full ${p1.color.tailwind}`} style={{ width: `${(p1.hp/MAX_HP)*100}%` }}></div>
                                    </div>
                                </div>

                                <div className="flex flex-col items-center">
                                    <div className="glass px-8 py-3 rounded-2xl border-white shadow-xl">
                                        <p className="text-[10px] font-black uppercase text-slate-400 text-center tracking-widest mb-1">Misi Sisa</p>
                                        <p className="font-mono text-3xl font-black text-slate-800">{Math.floor(timeLeft/60)}:{(timeLeft%60).toString().padStart(2, '0')}</p>
                                    </div>
                                    <div className={`mt-4 px-6 py-1 rounded-full text-[10px] font-black uppercase tracking-widest border-2 transition-all ${turnTimer < 20 ? 'bg-red-500 text-white animate-pulse border-red-400' : 'bg-white/80 text-slate-600 border-white'}`}>
                                        Targeting: {turnTimer}S
                                    </div>
                                </div>

                                <div className={`w-80 p-6 glass rounded-[2.5rem] transition-all duration-500 ${activePlayer === 2 ? 'ring-4 ring-red-500 scale-105 shadow-2xl' : 'opacity-50'}`}>
                                    <div className="flex justify-between items-end mb-3">
                                        <span className="font-mono text-sm font-bold">{Math.round(p2.hp)} HP</span>
                                        <span className="text-[10px] font-black uppercase text-red-700">{p2.name}</span>
                                    </div>
                                    <div className="h-3 bg-slate-200 rounded-full overflow-hidden">
                                        <div className={`hp-bar-fill h-full ${p2.color.tailwind}`} style={{ width: `${(p2.hp/MAX_HP)*100}%` }}></div>
                                    </div>
                                </div>
                            </div>

                            <div className="flex flex-col items-center pointer-auto w-full max-w-5xl mx-auto mb-10">
                                {!currentQ ? (
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-6 w-full animate-in fade-in slide-in-from-bottom-12 duration-700">
                                        {CATEGORIES.map(cat => (
                                            <button key={cat.id} onClick={()=>selectCategory(cat)} className="glass p-8 rounded-[3rem] border-white hover:bg-white/90 hover:-translate-y-3 transition-all flex flex-col items-center group shadow-xl">
                                                <div className={`p-5 rounded-3xl mb-4 group-hover:rotate-12 transition-transform bg-slate-100`}>
                                                    <i data-lucide={cat.icon} className={`w-10 h-10 ${cat.color}`}></i>
                                                </div>
                                                <p className="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-1">{cat.id}</p>
                                                <p className={`text-sm font-bold ${cat.color}`}>ATK: {cat.dmg}</p>
                                            </button>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="w-full animate-in zoom-in-95 duration-500">
                                        <div className="glass p-12 rounded-[4rem] shadow-2xl relative overflow-hidden">
                                            <div className={`absolute top-0 left-0 w-full h-2 ${activePlayer === 1 ? p1.color.tailwind : p2.color.tailwind}`}></div>
                                            
                                            <div className="flex justify-between items-center mb-10">
                                                <span className="text-[11px] font-black tracking-widest uppercase text-sky-700 bg-sky-100 px-5 py-2 rounded-full">Kategori: {currentQ.category}</span>
                                                <div className="flex items-center gap-3 text-slate-400">
                                                    <i data-lucide="timer" className="w-4 h-4"></i>
                                                    <span className="font-mono font-bold">{turnTimer}s</span>
                                                </div>
                                            </div>

                                            <div className="text-2xl font-bold mb-12 leading-relaxed text-center px-6 text-slate-800">
                                                {currentQ.q.split(/(\$.*?\$)/g).map((part, i) => 
                                                    part.startsWith('$') ? <span key={i} className="math-box mx-1 text-sky-700" data-math={part}>{part}</span> : part
                                                )}
                                            </div>

                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                                                {currentQ.a.map((ans, idx) => (
                                                    <button key={idx} onClick={()=>submitAnswer(idx)} className="text-left p-6 rounded-[2.5rem] bg-white/40 border-2 border-slate-100 hover:border-sky-500 hover:bg-white transition-all flex items-center gap-6 group shadow-sm">
                                                        <div className="w-12 h-12 rounded-2xl bg-sky-50 flex items-center justify-center font-black text-sky-600 group-hover:bg-sky-600 group-hover:text-white transition-all">
                                                            {String.fromCharCode(65+idx)}
                                                        </div>
                                                        <span className="text-sm font-bold text-slate-700">
                                                            {ans.split(/(\$.*?\$)/g).map((p, i) => p.startsWith('$') ? <span key={i} className="math-box" data-math={p}>{p}</span> : p)}
                                                        </span>
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                )}
                                
                                <div className="mt-10 glass-dark px-12 py-5 rounded-full text-white text-[11px] font-black border border-white/20 flex items-center gap-4 italic uppercase tracking-[0.2em] shadow-2xl animate-pulse">
                                    <div className="w-2 h-2 bg-sky-400 rounded-full animate-ping"></div>
                                    Tactical Feed: {log}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Game End Screen */}
                    {gameState === 'END' && (
                        <div className="flex-1 flex items-center justify-center p-6 pointer-auto">
                            <div className="glass p-16 rounded-[4.5rem] text-center max-w-4xl w-full border-white animate-in zoom-in-95 duration-1000 shadow-2xl">
                                <div className="mb-10 inline-block p-10 bg-amber-100 rounded-[3rem] shadow-xl">
                                    <i data-lucide="award" className="w-20 h-20 text-amber-600"></i>
                                </div>
                                <h2 className="text-6xl font-black mb-4 italic tracking-tighter uppercase text-slate-800">Operasi Selesai</h2>
                                <p className="text-2xl text-sky-600 font-black mb-12 tracking-widest uppercase">
                                    Pemenang: {p1.hp > p2.hp ? p1.name : p2.name}
                                </p>
                                
                                <div className="grid grid-cols-2 gap-8 mb-12">
                                    <div className="p-8 bg-sky-50 rounded-[2.5rem] border-2 border-sky-100">
                                        <p className="text-[10px] font-black uppercase text-sky-600 mb-2">Alpha Stats</p>
                                        <p className="text-3xl font-black">{p1.score} <span className="text-sm">Hits</span></p>
                                    </div>
                                    <div className="p-8 bg-red-50 rounded-[2.5rem] border-2 border-red-100">
                                        <p className="text-[10px] font-black uppercase text-red-600 mb-2">Bravo Stats</p>
                                        <p className="text-3xl font-black">{p2.score} <span className="text-sm">Hits</span></p>
                                    </div>
                                </div>

                                <button onClick={()=>window.location.reload()} className="btn-primary text-white px-16 py-6 rounded-3xl font-black text-xl hover:scale-105 transition-all uppercase tracking-widest shadow-2xl">Re-Deployment</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        // Lucide & KaTeX Global Polling
        setInterval(() => {
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }, 1000);
    </script>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</body>
</html>

